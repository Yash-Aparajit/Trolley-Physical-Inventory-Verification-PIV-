<!DOCTYPE html>
<html>
<head>
  <base target="_top" />
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{
      font-family: Arial;
      padding: 22px;
      font-size: 20px;
      max-width: 620px;
      margin: auto;
      background:#f6f7fb;
    }
    h2{margin:0 0 10px 0}
    input,button,textarea{
      font-size: 20px;
      padding: 14px;
      width: 100%;
      margin-top: 14px;
      border-radius: 10px;
      border:1px solid #ddd;
      box-sizing:border-box;
    }
    textarea{min-height:70px;resize:none}

    .btnScan{
      background:#111827;color:white;border:none;font-weight:700;
    }
    .btnSave{
      background:#2563eb;color:white;border:none;font-weight:700;
    }

    video{
      width:100%;
      margin-top:14px;
      border-radius:12px;
      display:none;
      background:black;
      min-height:260px;
    }

    #msg{
      margin-top:14px;
      padding:12px;
      border-radius:10px;
      display:none;
      font-size:16px;
      white-space:pre-line;
    }
    .ok{background:#dcfce7;color:#166534;display:block}
    .err{background:#fee2e2;color:#991b1b;display:block}

    .small{
      font-size:12px;color:#6b7280;margin-top:10px;line-height:1.4;
    }
  </style>
</head>

<body>
  <h2>‚úÖ Trolley PIV - QR Scan Verification</h2>

  <button class="btnScan" onclick="startScan()">üì∑ Start QR Scan</button>
  <video id="cam"></video>

  <input id="trolleyId" placeholder="Scan QR or type Trolley ID manually">

  <textarea id="remark" placeholder="Remark (optional)"></textarea>

  <input id="scannedBy" placeholder="Scanned By (name / ID)">

  <button id="saveBtn" class="btnSave" onclick="save()">‚úÖ Save</button>

  <div id="msg"></div>

  <div class="small">
    Rules:
    <br>1) Empty ID not allowed
    <br>2) ID must exist in MASTER
    <br>3) Duplicate scans rejected
  </div>

<script>
/******** MESSAGE AUTO HIDE ********/
let msgTimer = null;

function showMsg(text, ok){
  const box = document.getElementById("msg");
  box.className = ok ? "ok" : "err";
  box.innerText = text;
  box.style.display = "block";

  if(msgTimer) clearTimeout(msgTimer);
  msgTimer = setTimeout(() => {
    box.style.display = "none";
    box.innerText = "";
  }, 5000); 
}

/******** BEEP + VIBRATE ********/
function beep(){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(),g=ctx.createGain();
    g.gain.value=0.2; o.frequency.value=900;
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime+0.18);
  }catch(e){}
}

function vibrateStrong(){
  if(navigator.vibrate) navigator.vibrate([200,80,200]);
}

let stream=null;

/******** CAMERA START ********/
async function startScan(){
  showMsg("üì∑ Opening camera...", true);

  
  if(!("BarcodeDetector" in window)){
    showMsg("‚ùå QR scan not supported. Use Chrome and type ID manually.", false);
    return;
  }

  const v = document.getElementById("cam");

  try{
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    v.srcObject = stream;
    await v.play();
    v.style.display = "block";

    const detector = new BarcodeDetector({ formats: ["qr_code"] });

    const loop = async () => {
      if(!stream) return; 

      let codes = [];
      try{
        codes = await detector.detect(v);
      }catch(e){
        codes = [];
      }

      if(codes.length){
        const raw = (codes[0].rawValue || "").trim(); 
        document.getElementById("trolleyId").value = raw;

        beep(); vibrateStrong();
        stopScan();

        showMsg("‚úÖ QR scanned successfully.", true);
        return;
      }

      requestAnimationFrame(loop);
    };

    loop();

  }catch(err){
    stopScan();
    showMsg("‚ùå Camera error: " + err.message, false);
  }
}

/******** CAMERA STOP ********/
function stopScan(){
  const v = document.getElementById("cam");
  if(stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  v.style.display = "none";
}

/******** SAVE ********/
function save(){
  const trolleyId = (document.getElementById("trolleyId").value || "").trim(); 
  const remark = (document.getElementById("remark").value || "").trim();
  const scannedBy = (document.getElementById("scannedBy").value || "").trim();

  const saveBtn = document.getElementById("saveBtn");
  saveBtn.disabled = true;

  google.script.run
    .withSuccessHandler(res => {
      if(res.ok){
        beep(); vibrateStrong();
        showMsg(res.message + "\nTime: " + res.date + " " + res.time, true);

        
        document.getElementById("trolleyId").value = "";
        document.getElementById("remark").value = "";
        document.getElementById("trolleyId").focus();
      }else{
        showMsg(res.message, false);
      }
      saveBtn.disabled = false;
    })
    .withFailureHandler(err => {
      showMsg("‚ùå Server Error: " + err.message, false);
      saveBtn.disabled = false;
    })
    .saveScan({ trolleyId, remark, scannedBy });
}
</script>

</body>
</html>
